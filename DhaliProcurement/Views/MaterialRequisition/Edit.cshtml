@*@model DhaliProcurement.Models.Proc_RequisitionMas*@
@using DhaliProcurement.Helper
@model DhaliProcurement.ViewModel.VMRequisitionMasterDetail
@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
    DhaliProcurement.Models.DCPSContext db = new DhaliProcurement.Models.DCPSContext();
}

<div class="row">
    <div class="col-md-12">
        <!-- Basic layout-->
        <div class="panel panel-flat">
            <div class="panel-heading">
                <h5 class="panel-title">
                    <i class="icon-stack-plus position-left"></i>Edit Materials Requisition
                    @if (Model.requisitionMaster.Status == "A")
                    {
                        <span class="badge badge-success">Approved</span>
                    }
                    else
                    {
                        <span class="badge badge-danger">Pending Approved</span>
                    }
                </h5><hr />
                <div class="heading-elements">
                    <ul class="icons-list">
                        <li><a data-action="collapse"></a></li>
                    </ul>
                </div>
            </div>
            <div class="panel-body">
                @using (Html.BeginForm())
                {

                    <table class="table">
                        <tr>
                            <td>Project Name</td>
                            <td>

                                @*@Html.DropDownList("ProjectId", null, "--Select--", htmlAttributes: new { @id = "ProjectId", @class = "form-control select2", @style = "width: 500px !important" })*@
                                <input type="text" value="@ViewBag.ProjectName" class="form-control" disabled="disabled" />
                                <input type="hidden" value="@ViewBag.ProjectId" id="ProjectId" />
                                <input type="hidden" value="@ViewBag.RequisitionMasId" id="RequisitionMasId" />
                                @*@ViewData["ReqMAsterId"] = ViewBag.RequisitionMasId;*@
                                @Html.ValidationMessage("ProjectId", "", new { @class = "text-danger" })

                            </td>
                            <td>Req. No.</td>
                            <td>
                                @Html.TextBox("Rcode", Model.requisitionMaster.Rcode, new { @class = "form-control" })
                                @*<input type="text" value="@ViewBag.ReqNo" class="form-control" id="ReqNo"/>*@
                            </td>
                        </tr>
                        <tr>
                            <td>Site Name</td>
                            <td>
                                @*@Html.DropDownList("SiteId", null, "--Select--", htmlAttributes: new { @id = "SiteId", @class = "form-control select2", @style = "width: 500px !important" })*@
                                <input type="text" value="@ViewBag.SiteName" class="form-control" disabled="disabled" />
                                <input type="hidden" value="@ViewBag.SiteId" id="SiteId" />
                                @Html.ValidationMessage("SiteId", "", new { @class = "text-danger" })
                            </td>
                            <td>Requisition Date</td>
                            <td>
                                @*@Html.TextBox("ReqDate", NullHelper.DateToString(Model.requisitionMaster.ReqDate), new { @class = "form-control datepicker" })*@
                                @Html.TextBox("ReqDate", NullHelper.DateToString(Model.requisitionMaster.ReqDate), new { @class = "form-control datepicker" })
                                @*<input type="text" value="@ViewBag.ReqDate" class="form-control datepicker" id="ReqDate" />*@
                            </td>
                        </tr>

                        <tr>
                            <td>Site Engineer</td>
                            <td>
                                @Html.TextBox("SiteEngineer", null, new { @class = "form-control", disabled = "true" })
                            </td>

                        </tr>

                        <tr>
                            <td>Project Manager</td>
                            <td>
                                @Html.TextBox("ProjectManager", null, new { @class = "form-control", disabled = "true" })
                            </td>
                        </tr>
                        <tr>
                            <td>Remarks</td>
                            <td>
                                @Html.TextBox("Remarks", Model.requisitionMaster.Remarks, new { @class = "form-control" })
                            </td>

                        </tr>

                    </table>
                    <hr />
                    <div class="details well" style=" border 1px solid black;">
                        <h4>Requisition Items</h4>
                        <table style="width: 100%;">
                            <tr>
                                @*<td style="font-size: 15px; font-weight: bold;">Sl. No.</td>*@
                                <th style="font-size: 15px; font-weight: bold;">Required Materials</th>
                                <th style="font-size: 15px; font-weight: bold;">Unit</th>
                                <th style="font-size: 15px; font-weight: bold;">Total Required</th>
                                <th style="font-size: 15px; font-weight: bold;">Total Received</th>
                                <th style="font-size: 15px; font-weight: bold;">Remaining</th>
                                <th style="font-size: 15px; font-weight: bold;">Current Stock</th>
                                <th style="font-size: 15px; font-weight: bold;">Req. Qty</th>
                                <th style="font-size: 15px; font-weight: bold;">Required Before(Date)</th>
                                <th style="font-size: 15px; font-weight: bold;">Brand/Quantity</th>
                                <th style="font-size: 15px; font-weight: bold;">Size</th>

                                <th style="font-size: 15px; font-weight: bold;">Remarks</th>
                                <th>&nbsp;</th>
                                <th>&nbsp;</th>
                            </tr>
                            <tr>
                                <td>

                                    @Html.DropDownList("ItemName", null, "Select item", htmlAttributes: new { @class = "form-control select2", @data_required = "required", @id = "ItemName", @style = "width: 150px;" })
                                    @*<span class="error">Item name required</span>*@
                                </td>
                                @*<td>
                                        <input type="text" id="Qty" class="form-control" />
                                        <span class="error">Valid quantity required</span>
                                    </td>*@
                                <td>
                                    @*@Html.DropDownList("Unit", null, "Select unit", htmlAttributes: new { @class = "form-control select2", @data_required = "required", @style = "width: 150px;" })*@
                                    @Html.TextBox("Unit", "", new { @disabled = "disabled", @class = "form-control", @id = "UnitName" })
                                    <input type="hidden" value="" id="UnitId" />
                                    @*<span class="error">Unit required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="TotalRequired" class="form-control" disabled="disabled" />
                                    @*<span class="error">Valid rate required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="TotalReceived" class="form-control" disabled="disabled" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="RemainingBalance" class="form-control" disabled="disabled" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="CurrentStock" class="form-control" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="ReqQty" class="form-control" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="RequiredDate" class="form-control datepicker" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="Brand" class="form-control" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="text" id="Size" class="form-control" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>

                                <td>
                                    <input type="text" id="ItemRemarks" class="form-control" />
                                    @*<span class="error">Item remarks required</span>*@
                                </td>
                                <td>
                                    <input type="button" id="addNewRow" value="+" class="btn btn-primary" style="background-color: grey;border: none;" />
                                    @*<span class="error">required</span>*@
                                </td>
                                <td>&nbsp;</td>
                            </tr>
                            <tr>
                                <td><span class="error" id="ItemName_Error">Item name required</span></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                @*<td><span class="error" id="CurrentStock_Error">Current Stock required</span></td>*@
                                <td><span class="error" id="ReqQty_Error">Req Qty must be a number</span></td>
                                @*<td><span class="error" id="Brand_Error">brand required</span></td>
                                    <td><span class="error" id="Size_Error">Size required</span></td>
                                    <td><span class="error" id="RequiredDate_Error">Date required</span></td>*@
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                        <br />
                        <div class="table-responsive scrolling">
                            <table class="Resource-list table table-bordered" id="RequisitionDetails">
                                <tr class="bg-grey">
                                    @*<th>Sl. No.</th>*@
                                    <th>Required Materials</th>
                                    <th>Unit</th>
                                    <th>Total Required</th>
                                    <th>Total Received</th>
                                    <th>Remaining</th>
                                    <th>Current Stock</th>
                                    <th>Req. Qty</th>
                                    <th>Required Before(Date)</th>
                                    <th>Brand/Quantity</th>
                                    <th>Size</th>
                                    <th>Remarks</th>
                                    <th>&nbsp;</th>
                                </tr>
                                @foreach (var item in Model.requisitionDetail)
                                {
                                    <tr>
                                        <td>
                                            @*<input type="hidden" value="@item.Id" name="RequisitionDetId"/>*@
                                            <input type="hidden" value="@item.Id" name="TaskId" />
                                            @{
                                                var itemName = db.Item.SingleOrDefault(x => x.Id == item.ItemId);
                                            }                                         
                                            <input class="form-control" value="@itemName.Name" type="text" name="ItemName"  style="width:90px;" disabled="disabled"/>
                                            @*<input type="text" value="@itemName.Name" class="form-control" />*@
                                            <input type="hidden" value="@item.ItemId" class="form-control" name="ItemId" />
                                        </td>
                                        <td>
                                            @{
                                                var unit = (from requisitionDet in db.Proc_RequisitionDet
                                                            join ProcProjectItem in db.ProcProjectItem on requisitionDet.ItemId equals ProcProjectItem.ItemId
                                                            join units in db.Unit on ProcProjectItem.UnitId equals units.Id
                                                            where ProcProjectItem.ItemId == item.ItemId
                                                            select units).FirstOrDefault();
                                            }
                                            @*<label>@unit.Name</label>*@
                                            <input type="text" value="@unit.Name" class="form-control" name="ItemUnit" style="width:80px;"  disabled="disabled"/>
                                            <input type="hidden" value="@unit.Id" class="form-control" name="UnitId" />
                                        </td>
                                        <td>
                                            @{
                                                int sid = ViewBag.SiteId;
                                                int pid = ViewBag.ProjectId;
                                                int itemid = item.ItemId;
                                                //var totalRequired = (from procProjectItem in db.ProcProjectItem
                                                //                     join procproject in db.ProcProject on procProjectItem.ProcProjectId equals procproject.Id
                                                //                     join site in db.ProjectSite on procproject.ProjectSiteId equals site.Id
                                                //                     join project in db.Project on site.ProjectId equals project.Id
                                                //                     where  procProjectItem.ItemId == itemid && procproject.ProjectSiteId == sid
                                                //                     select procProjectItem).FirstOrDefault();
                                                var totalRequired = (from procProjectItem in db.ProcProjectItem
                                                                     join procproject in db.ProcProject on procProjectItem.ProcProjectId equals procproject.Id
                                                                     join site in db.ProjectSite on procproject.ProjectSiteId equals site.Id
                                                                     join project in db.Project on site.ProjectId equals project.Id
                                                                     where procProjectItem.ItemId == itemid && project.Id == pid && site.Id == sid
                                                                     select procProjectItem).FirstOrDefault();
                                            }

                                            @*<input type="text" value="" class="form-control" name="TotalRequired" disabled="disabled" />*@
                                            <input type="text" value="@totalRequired.PQuantity" class="form-control" name="TotalRequired" disabled="disabled" style="width:90px;" />
                                        </td>
                                        <td>
                                            @{
                                                decimal total = 0;
                                                var totalReceived = (from entryDet in db.Proc_MaterialEntryDet
                                                                     join purchaseDet in db.Proc_PurchaseOrderDet on entryDet.Proc_PurchaseOrderDetId equals purchaseDet.Id
                                                                     join purchaseMas in db.Proc_PurchaseOrderMas on purchaseDet.Proc_PurchaseOrderMasId equals purchaseMas.Id
                                                                     join tenderDet in db.Proc_TenderDet on purchaseMas.Proc_TenderMasId equals tenderDet.Proc_TenderMasId
                                                                     where purchaseDet.ItemId == item.ItemId
                                                                     select entryDet.EntryQty).Distinct().ToList();
                                                //var totalReceived = 0;
                                                foreach (var i in totalReceived)
                                                {
                                                    total = total + i;
                                                }
                                            }
                                            <input type="text" value="@total" class="form-control" name="TotalReceived" disabled="disabled" style="width:90px;" />
                                            @*<input type="text" value="@totalReceived.EntryQty" class="form-control" name="TotalReceived" disabled="disabled" />*@
                                        </td>
                                        <td>
                                            @{


                                                var remaining = totalRequired.PQuantity - total;
                                            }
                                            <input type="text" value="@remaining" class="form-control" name="RemainingBalance" disabled="disabled" style="width:90px;" />
                                        </td>
                                        <td>
                                            <input type="text" value="@item.CStockQty" class="form-control" name="CStockQty" style="width:80px;" />
                                        </td>
                                        <td>
                                            <input type="text" value="@item.ReqQty" class="form-control" name="ReqQty" style="width:80px;" />
                                        </td>
                                        <td>
                                            @{
                                                var requiredDate = NullHelper.DateToString(item.RequiredDate);
                                            }
                                            @*<input type="text" value="@item.RequiredDate" class="form-control datepicker" name="RequiredDate" />*@
                                            <input type="text" value="@requiredDate" class="form-control datepicker" name="RequiredDate" style="width:80px;" />
                                        </td>
                                        <td>
                                            <input type="text" value="@item.Brand" class="form-control" name="Brand" style="width:90px;" />
                                        </td>
                                        <td>
                                            <input type="text" value="@item.Size" class="form-control" name="Size" style="width:80px;" />
                                        </td>

                                        <td>
                                            <input type="text" value="@item.Remarks" class="form-control" name="ItemRemarks" style="width:80px;" />
                                        </td>
                                        <td>
                                            <button type="button" id="editSite" class="btn text-primary-400 btn-flat btn-icon btn-rounded  btn-xs editSite " data-toggle="modal" data-target="#detailForm"><i class="icon-pencil"></i></button>
                                            <button type="button" class="btn  text-warning-600 btn-flat btn-icon btn-rounded deleteRequisitionItem"><i class="icon-cross"></i></button>
                                            @*<input type="button" class="btn btn-danger btn-xs deleteRequisitionItem" value="Delete"/>*@
                                            @*<input type="button" class="btn btn-danger btn-xs deleteItem" value="Delete" onclick="$(this).parent().parent().remove();" />*@
                                            @*<span class="btn text-warning-600 btn-flat btn-icon btn-rounded" onclick="RemoveTask(@item.Id)"><i class="icon-cross"></i></span>*@
                                        </td>

                                        @*@{
                                                var unit = (from procProjectItem in db.ProcProjectItem
                                                           join itemUnit in db.Unit on procProjectItem.UnitId equals itemUnit.Id
                                                           where procProjectItem.ItemId== item.ItemId
                                                           select itemUnit.Name).FirstOrDefault().ToString();
                                            }
                                            <td>@unit</td>*@
                                    </tr>
                                                }
                            </table>
                        </div>


                    </div>

                                                }
            </div>



        </div>


    </div>
    <div class="form-group">
        <div class="col-md-12" style="text-align:center;">
            @*<input type="button" id="deletecheck" value="Delete Selected"/>*@
            @*@Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-info" , @style = "background-color: grey;border: none;" })*@
            @*<button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>  Save</button>*@
            @*@if (Model.requisitionMaster.Status.Trim() == "A")
                {
                    <button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>Save</button>
                }
                else
                {
                    <button type="button" id="ApproveItem" class="btn btn-danger"><i class="icon-floppy-disk position-left"></i>Approve</button>
                }*@
            @if (User.IsInRole("Management"))
            {
                if (Model.requisitionMaster.Status.Trim() == "A")
                {
                    <button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>Update</button>
                }
                else
                {
                    <button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>Update</button>
                    <button type="button" id="ApproveItem" class="btn btn-danger"><i class="icon-select2 position-left"></i>Approve</button>
                }
            }
            else
            {
                if (Model.requisitionMaster.Status.Trim() == "A")
                {
                    <button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>Update</button>
                }
                else
                {
                    @*<button type="button" id="SaveItem" class="btn btn-success"><i class="icon-floppy-disk position-left"></i>Update</button>*@
                    <button type="button" id="ApproveItem" class="btn btn-danger" disabled="disabled"><i class="icon-select2 position-left"></i>Pending Approval</button>
                }
            }

        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="detailForm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog" role="document" style="overflow-y: scroll; max-height:85%;  margin-top: 50px; margin-bottom:50px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="panel-body">
                    @Html.AntiForgeryToken()

                    <div class="form-horizontal">
                        <div class="form-group">
                            <input type="hidden" id="ProjectId" value="" />
                        </div>
                        <div class="form-group">
                            @Html.Label("Item Name", htmlAttributes: new
                       {
                           @class = "control-label col-md-2"@*, @style="font-weight:bold;"*@ })
                            <div class="col-md-10">
                                @Html.DropDownList("ItemName", null, "Select item", htmlAttributes: new { @class = "form-control select2", @data_required = "required", @id = "ModalItemName", @style = "width: 150px;" })
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.Label("Unit", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                <input type="hidden" id="modalunitId" />
                                @Html.TextBox("ModalUnitName", null, new { @class = "form-control", @disabled = "disabled" })
                                @*@Html.DropDownList("Unit", null, "Select unit", htmlAttributes: new { @class = "form-control select2", @id = "ModalUnit", @data_required = "required", @style = "width: 150px;" })*@
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Total Required", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalTotalRequired", null, new { @class = "form-control", @disabled = "disabled" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Total Received", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalTotalReceived", null, new { @class = "form-control", @disabled = "disabled" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Remaining Balance", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalRemainingBalance", null, new { @class = "form-control", @disabled = "disabled" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("CurrentStock", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalCurrentStock", null, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Qty", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalQty", null, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Required Date", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalRequiredDate", null, new { @class = "form-control datepicker" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Brand", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalBrand", null, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Size", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalSize", null, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Remarks", htmlAttributes: new { @class = "control-label col-md-2" })
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="col-md-10">
                                @Html.TextBox("ModalRemarks", null, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="col-md-offset-2 col-md-10">
                                <button type="submit" class="btn btn-primary" id="ModalDetailSave">Save</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    var counter = 0;
    var selRow;

    $(document).ready(function () {
        RebindDatePicker();
        $(".select2").select2();
        $('#ItemName_Error').hide();
        $('#ReqQty_Error').hide();
    });

    $("#ItemName").change(function () {
        var ItemId = $('#ItemName option:selected').val();
        var ProjectId = $('#ProjectId').val();
        var SiteId = $('#SiteId').val();

        if (ProjectId == "" && SiteId == "") {
            alert('Please Select Project Id and Site Id');
        }

        //alert(ProjectId);
        //alert(SiteId);

        $.ajax({
            type: "post",
            url: "/MaterialRequisition/GetUnit",
            data: { ItemId, ProjectId, SiteId },
            datatype: "json",
            traditional: true,
            success: function (data) {
                $('#UnitId').val(data.UnitId);
                $('#UnitName').val(data.UnitName);
                $('#TotalRequired').val(data.TotalRequired);
                $('#TotalReceived').val(data.TotalReceived);
                var totalRequied = $('#TotalRequired').val();
                var totalReceived = $('#TotalReceived').val();
                if (totalReceived == "") {
                    totalReceived = 0;
                }
                var remaining = totalRequied - totalReceived
                $('#RemainingBalance').val(remaining);
            }

        });
    });

    //add new row
    $('#addNewRow').click(function (event) {
        event.preventDefault();
        counter++;
        var isAllValid = true;
        var ItemId = $('#ItemName option:selected').val();
        //alert(ItemId);
        var ItemName = $('#ItemName option:selected').text();
        //alert(ItemName);
        //var Qty = $('#Qty').val();
        var Unit = $('#UnitName').val();
        //var Unit = $('#Unit option:selected').text();

        var UnitId = $('#UnitId').val();
        //alert(Unit);
        //var UnitId = $('#Unit option:selected').val();
        //alert(UnitId);
        var TotalRequired = $('#TotalRequired').val();
        var TotalReceived = $('#TotalReceived').val();
        var RemainingBalance = $('#RemainingBalance').val();
        var CurrentStock = $('#CurrentStock').val();
        var ReqQty = $('#ReqQty').val();
        //alert(ReqQty);
        var Brand = $('#Brand').val();
        var Size = $('#Size').val();
        var requiredDate = $('#RequiredDate').val();
        var ItemRemarks = $('#ItemRemarks').val();

        if (ItemName == "" || ItemName == "Select item") {
            $('#ItemName_Error').show();
            isAllValid = false;
        }
        else {
            //$('#ItemName_Error').css('visibility', 'hidden');
            $('#ItemName_Error').hide();
        }

        if (ReqQty == "" || isNaN(ReqQty)) {
            $('#ReqQty_Error').show();
            isAllValid = false;
        }
        else {
            $('#ReqQty_Error').hide();
        }

        $('table.Resource-list tr').each(function () {
            var name = $(this).find("td input[name=ItemName]").val();
            //alert(name);
            ItemName = $('#ItemName option:selected').text();
            //alert('This name: ' + ItemName);
            if (ItemName == name) {
                alert('This item already exists!');
                isAllValid = false;
            }

        });


        if (isAllValid) {
            var newRow = jQuery('<tr>'
                    + '<td><input value="' + ItemId + '" type="hidden" name="ItemId"/> <input class="form-control" value="' + ItemName + '" type="text" name="ItemName"  style="width:80px;"/><input type="hidden" value="0" name="TaskId"></td>'
                    //+ '<td><input type="hidden" value="' + UnitId + '" type="text" name="UnitId"/></td>'
                    + '<td><input value="' + UnitId + '" type="hidden" name="UnitId"/> <input class="form-control" value="' + Unit + '" type="text" name="ItemUnit"  style="width:80px;"/></td>'
                    + '<td><input class="form-control" value="' + TotalRequired + '"  type="text" name="TotalRequired"/></td>'
                    + '<td><input class="form-control" value="' + TotalReceived + '"  type="text" name="TotalReceived"/></td>'
                    + '<td><input class="form-control" value="' + RemainingBalance + '"  type="text" name="RemainingBalance"/></td>'
                    + '<td><input class="form-control" value="' + CurrentStock + '"  type="text" name="CStockQty" style="width:80px;"/></td>'
                    + '<td><input class="form-control" value="' + ReqQty + '"  type="text" name="ReqQty" style="width:80px;"/></td>'
                    + '<td><input class="form-control datepicker" value="' + requiredDate + '" type="text" name="RequiredDate"/></td>'
                    + '<td><input class="form-control" value="' + Brand + '"  type="text" name="Brand" style="width:80px;"/></td>'
                    + '<td><input class="form-control" value="' + Size + '"  type="text" name="Size"style="width:80px;"/></td>'
                    + '<td><input class="form-control" value="' + ItemRemarks + '" type="text" name="ItemRemarks"/></td>'
                    //+ '</td><td> <input type="button" class="btn btn-danger btn-xs deleteItem" value="Delete" onclick="$(this).parent().parent().remove();" /></td></tr>');
                    +'<td>'
                     + '<button type="button" id="editSite" class="btn text-primary-400 btn-flat btn-icon btn-rounded  btn-xs editSite " data-toggle="modal" data-target="#detailForm"><i class="icon-pencil"></i></button>'
                     + ' <button type="button" class="btn text-warning-600 btn-flat btn-icon btn-rounded" onclick="$(this).parent().parent().remove();"><i class="icon-cross"></i></button>'
                     + '</td></tr>');


            jQuery('table.Resource-list').append(newRow);

            $('#ItemName').val("");
            $('#UnitName').val("");
            $('#TotalRequired').val("");
            $('#TotalReceived').val("");
            $('#RemainingBalance').val("");
            $('#CurrentStock').val("");
            $('#ReqQty').val("");
            $('#Brand').val("");
            $('#Size').val("");
            $('#RequiredDate').val("");
            $('#ItemRemarks').val("");

            RebindDatePicker();


            $('.editSite').click(function () {
                var row = $(this).closest('tr');
                selRow = $(this).closest('tr');
                var itemName = row.find('input[name=ItemName]').val();
                var itemId = row.find('input[name=ItemId]').val();
                var ItemUnit = row.find('input[name=ItemUnit]').val();
                var UnitId = row.find('input[name=UnitId]').val();
                var TotalRequired = row.find('input[name=TotalRequired]').val();
                var TotalReceived = row.find('input[name=TotalReceived]').val();
                var RemainingBalance = row.find('input[name=RemainingBalance]').val();
                var CurrentStock = row.find('input[name=CStockQty]').val();
                var ReqQty = row.find('input[name=ReqQty]').val();
                var RequiredDate = row.find('input[name=RequiredDate]').val();
                var Brand = row.find('input[name=Brand]').val();
                var Size = row.find('input[name=Size]').val();
                var ItemRemarks = row.find('input[name=ItemRemarks]').val();
                //$('#ModalItemName').val(SiteName);
                $('#ModalItemName').val(itemId).change();
                $('#modalunitId').val(UnitId);
                $('#ModalUnitName').val(ItemUnit);
                $('#ModalTotalRequired').val(TotalRequired);
                $('#ModalTotalReceived').val(TotalReceived);
                $('#ModalRemainingBalance').val(RemainingBalance);
                $('#ModalCurrentStock').val(CurrentStock);
                $('#ModalQty').val(ReqQty);
                $('#ModalRequiredDate').val(RequiredDate);
                $('#ModalBrand').val(Brand);
                $('#ModalSize').val(Size);
                $('#ModalRemarks').val(ItemRemarks);

            });

        }

        //var newRow = jQuery('<tr><td class="index"><label name="TaskId">' + counter + '</label></td>'
        //    + '<td><input value="' + ItemId + '" type="hidden" name="ItemId"/> <input class="form-control" value="' + ItemName + '" type="hidden" name="ItemName' + counter + '"/><label>' + ItemName + '<label></td>'
        //    //+ '<td><input type="hidden" value="' + UnitId + '" type="text" name="UnitId"/></td>'
        //    + '<td><input value="' + UnitId + '" type="hidden" name="UnitId"/><label>' + Unit + '</label></td>'
        //    + '<td><input class="form-control" value="' + TotalRequired + '"  type="text" name="TotalRequired"/></td>'
        //    + '<td><input class="form-control" value="' + TotalReceived + '"  type="text" name="TotalReceived"/></td>'
        //    + '<td><input class="form-control" value="' + RemainingBalance + '"  type="text" name="RemainingBalance"/></td>'
        //    + '<td><input class="form-control" value="' + CurrentStock + '"  type="text" name="CurrentStock"/></td>'
        //    + '<td><input class="form-control" value="' + ReqQty + '"  type="text" name="ReqQty" style="width:80px;"/></td>'
        //    + '<td><input class="form-control" value="' + Brand + '"  type="text" name="Brand" style="width:80px;"/></td>'
        //    + '<td><input class="form-control" value="' + Size + '"  type="text" name="Size"style="width:80px;"/></td>'
        //    + '<td><input class="form-control" value="' + ItemRemarks + '" type="text" name="ItemRemarks"/>'
        //    + '</td> <td> <input type="button" class="btn btn-danger btn-xs" value="Delete" onclick="$(this).parent().parent().remove();" /></td></tr>');

    });


    $('.editSite').click(function () {
        var row = $(this).closest('tr');
        selRow = $(this).closest('tr');
        var itemName = row.find('input[name=ItemName]').val();
        var itemId = row.find('input[name=ItemId]').val();
        var ItemUnit = row.find('input[name=ItemUnit]').val();
        var UnitId = row.find('input[name=UnitId]').val();
        var TotalRequired = row.find('input[name=TotalRequired]').val();
        var TotalReceived = row.find('input[name=TotalReceived]').val();
        var RemainingBalance = row.find('input[name=RemainingBalance]').val();
        var CurrentStock = row.find('input[name=CStockQty]').val();
        var ReqQty = row.find('input[name=ReqQty]').val();
        var RequiredDate = row.find('input[name=RequiredDate]').val();
        var Brand = row.find('input[name=Brand]').val();
        var Size = row.find('input[name=Size]').val();
        var ItemRemarks = row.find('input[name=ItemRemarks]').val();
        //$('#ModalItemName').val(SiteName);
        $('#ModalItemName').val(itemId).change();
        $('#modalunitId').val(UnitId);
        $('#ModalUnitName').val(ItemUnit);
        $('#ModalTotalRequired').val(TotalRequired);
        $('#ModalTotalReceived').val(TotalReceived);
        $('#ModalRemainingBalance').val(RemainingBalance);
        $('#ModalCurrentStock').val(CurrentStock);
        $('#ModalQty').val(ReqQty);
        $('#ModalRequiredDate').val(RequiredDate);
        $('#ModalBrand').val(Brand);
        $('#ModalSize').val(Size);
        $('#ModalRemarks').val(ItemRemarks);

    });




    $("#ModalItemName").change(function () {
        var ItemId = $('#ModalItemName option:selected').val();
        //alert(ItemId);
        var ProjectId = $('#ProjectId').val();
        var SiteId = $('#SiteId').val();

        if (ProjectId == "" && SiteId == "") {
            alert('Please Select Project Id and Site Id');
        }

        //alert(ProjectId);
        //alert(SiteId);

        $.ajax({
            type: "post",
            url: "/MaterialRequisition/GetUnit",
            data: { ItemId, ProjectId, SiteId },
            datatype: "json",
            traditional: true,
            success: function (data) {
                $('#modalunitId').val(data.UnitId);
                $('#ModalUnitName').val(data.UnitName);
                $('#ModalTotalRequired').val(data.TotalRequired);
                //alert(data.TotalReceived);
                $('#ModalTotalReceived').val(data.TotalReceived);
                //$('#TotalReceived').val(0);
                var TotalRequired = $('#ModalTotalRequired').val();
                var TotalReceived = $('#ModalTotalReceived').val();
                var RemainingBalance = TotalRequired - TotalReceived;

                $('#ModalRemainingBalance').val(RemainingBalance);
            }

        });
    });

    $('#ModalDetailSave').click(function () {
        var ItemName = $('#ModalItemName option:selected').text();
        var ItemId = $('#ModalItemName option:selected').val();
        var Unitid = $('#modalunitId').val();
        var UnitName = $('#ModalUnitName').val();
        var ModalTotalRequired = $('#ModalTotalRequired').val();
        var ModalTotalReceived = $('#ModalTotalReceived').val();
        var ModalRemainingBalance = $('#ModalRemainingBalance').val();
        var ModalCurrentStock = $('#ModalCurrentStock').val();
        var Qty = $('#ModalQty').val();
        var ModalRequiredDate = $('#ModalRequiredDate').val();
        var ModalBrand = $('#ModalBrand').val();
        var ModalSize = $('#ModalSize').val();
        var Remarks = $('#ModalRemarks').val();


        selRow.find('input[name=ItemName]').val(ItemName);
        selRow.find('input[name=ItemId]').val(ItemId);
        selRow.find('input[name=ItemUnit]').val(UnitName);
        selRow.find('input[name=UnitId]').val(Unitid);
        selRow.find('input[name=TotalRequired]').val(ModalTotalRequired);
        selRow.find('input[name=TotalReceived]').val(ModalTotalReceived);
        selRow.find('input[name=RemainingBalance]').val(ModalRemainingBalance);
        selRow.find('input[name=CStockQty]').val(ModalCurrentStock);
        selRow.find('input[name=ReqQty]').val(Qty);
        selRow.find('input[name=RequiredDate]').val(ModalRequiredDate);
        selRow.find('input[name=Brand]').val(ModalBrand);
        selRow.find('input[name=Size]').val(ModalSize);
        selRow.find('input[name=ItemRemarks]').val(Remarks);

        $('#detailForm').modal('hide');
    });


    $('#SaveItem').click(function (e) {

        if ($.trim($('#ReqDate').val()) === "") {
            alert('Requisition date required');
            //swal('Requisition date required');
            $('#ReqDate').focus();
        }
        else if ($.trim($('#Rcode').val()) === "") {
            alert('Please insert Requisition No.');
            //swal('Please insert Requisition No.');
            $('#Rcode').focus();
        }
        else if ($('.Resource-list tr').length < 2) {
            alert('Please Add Item to this requisition');
        }
        else {
            CreateSitePlanTask();
        }
    });

    function CreateSitePlanTask() {
        //==========Master Form==========

        //var ProjectId = document.getElementById("ProjectId");
        var ProjectId = $("#ProjectId").val();
        //RequisitionMasId
        var RequisitionMasId = $("#RequisitionMasId").val();
        //alert(RequisitionMasId);
        //alert('project Id: ' + ProjectId);
        var SiteId = $("#SiteId").val();
        //alert('Site Id: ' + SiteId);
        var RequisitionDate = $("#ReqDate").val();
        //alert('RequisitionDate: ' + RequisitionDate);
        var ReqNo = $("#Rcode").val();
        //alert('ReqNo: ' + ReqNo);
        var SiteEngineer = $("#SiteEngineer").val();
        //alert('SiteEngineer: ' + SiteEngineer);
        var Projectmanager = $("#ProjectManager").val();
        //alert('Projectmanager: ' + Projectmanager);
        var remarks = $("#Remarks").val();
        //alert('remarks: ' + remarks);


        //===========Detail Form===========
        var ProcRequisitionDetId =  document.getElementsByName("TaskId");
        var ItemId = document.getElementsByName("ItemId");
        var TotalRequired = document.getElementsByName("TotalRequired");
        var TotalReceived = document.getElementsByName("TotalReceived");
        var RemainingBalance = document.getElementsByName("RemainingBalance");
        var CurrentStock = document.getElementsByName("CStockQty");
        var ReqQty = document.getElementsByName("ReqQty");
        var Brand = document.getElementsByName("Brand");
        var Size = document.getElementsByName("Size");
        var RequiredDate = document.getElementsByName("RequiredDate");
        var ItemRemarks = document.getElementsByName("ItemRemarks");


        var RequisitionItems = [];

        var tableCounter = $('#RequisitionDetails tr').length - 1;

        for (var i = 0; i < tableCounter; i++) {
            RequisitionItems.push({
                ProcRequisitionDetId: ProcRequisitionDetId[i].value,
                ItemId: ItemId[i].value,
                ReqQty: ReqQty[i].value,
                CStockQty: CurrentStock[i].value,
                Brand: Brand[i].value,
                Size: Size[i].value,
                RequiredDate: RequiredDate[i].value,
                ItemRemarks: ItemRemarks[i].value
            });
            console.log('---------->');
            console.log('ItemId: ' + RequisitionItems[i].ItemId);
            console.log('CurrentStock: ' + RequisitionItems[i].CStockQty);
            console.log('ReqQty: ' + RequisitionItems[i].ReqQty);
            console.log('Brand: ' + RequisitionItems[i].Brand);
            console.log('Size: ' + RequisitionItems[i].Size);
            console.log('Required Date: ' + RequisitionItems[i].RequiredDate);
            console.log('ItemRemarks: ' + RequisitionItems[i].ItemRemarks);
            console.log('---------->');

        }

        TaskDetails = JSON.stringify({
            RequisitionItems: RequisitionItems,
            DeleteItems: deleteList,
            ProjectId: ProjectId,
            SiteId: SiteId,
            RequisitionDate: RequisitionDate,
            ReqNo: ReqNo,
            remarks: remarks,
            RequisitionMasId: RequisitionMasId
        });


        $.ajax({
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            type: 'POST',
            url: '/MaterialRequisition/EditRequisition',
            data: TaskDetails,
            success: function (result) {
                console.log(result);
                if (result.flag === true) {

                    alert("Record save successfully!");

                    $('#ProjectId').val("");
                    $('#SiteId').val("");
                    $('#RequisitionDate').val("");
                    $('#ReqNo').val("");
                    $('#SiteEngineer').val("");
                    $('#ProjectManager').val("");
                    $('#ProjectRemarks').val("");


                    window.location.replace("/MaterialRequisition/Index");


                }
                else {
                    alert(result.message);
                }


            },
            failure: function (response) {
                alert('error');
            }
        });

    }



    $('#ApproveItem').click(function () {
        var Status = "A";
        var RequisitionMasId = $("#RequisitionMasId").val();
        //alert(RequisitionMasId);

        //===========Detail Form===========
        var ItemId = document.getElementsByName("ItemId");
        var TotalRequired = document.getElementsByName("TotalRequired");
        var TotalReceived = document.getElementsByName("TotalReceived");
        var RemainingBalance = document.getElementsByName("RemainingBalance");
        var CurrentStock = document.getElementsByName("CStockQty");
        var ReqQty = document.getElementsByName("ReqQty");
        var Brand = document.getElementsByName("Brand");
        var Size = document.getElementsByName("Size");
        var RequiredDate = document.getElementsByName("RequiredDate");
        var ItemRemarks = document.getElementsByName("ItemRemarks");

        var RequisitionItems = [];

        var tableCounter = $('#RequisitionDetails tr').length - 1;

        for (var i = 0; i < tableCounter; i++) {
            RequisitionItems.push({
                ItemId: ItemId[i].value,
                ReqQty: ReqQty[i].value,
                CStockQty: CurrentStock[i].value,
                Brand: Brand[i].value,
                Size: Size[i].value,
                RequiredDate: RequiredDate[i].value,
                ItemRemarks: ItemRemarks[i].value
            });
            console.log('---------->');
            console.log('ItemId: ' + RequisitionItems[i].ItemId);
            console.log('CurrentStock: ' + RequisitionItems[i].CStockQty);
            console.log('ReqQty: ' + RequisitionItems[i].ReqQty);
            console.log('Brand: ' + RequisitionItems[i].Brand);
            console.log('Size: ' + RequisitionItems[i].Size);
            console.log('Required Date: ' + RequisitionItems[i].RequiredDate);
            console.log('ItemRemarks: ' + RequisitionItems[i].ItemRemarks);
            console.log('---------->');

        }

        TaskDetails = JSON.stringify({
            RequisitionItems: RequisitionItems,
            RequisitionMasId: RequisitionMasId,
            Status: Status
        });

        $.ajax({
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            type: 'POST',
            url: '/MaterialRequisition/ApproveRequisition',
            data: TaskDetails,
            success: function (result) {
                console.log(result);
                if (result.flag === true) {
                    alert("Record approved successfully!");
                    
                    window.location.replace("/MaterialRequisition/Index");
                }
                else {
                    alert(result.message);
                }

            },
            failure: function (response) {
                alert('error');
            }
        });
    });


    var deleteCounter = 0;
    var deleteList = [];



    $('.deleteRequisitionItem').click(function () {
        //if (retVal == true) {
            var row = $(this).closest('tr');
            var itemDetId = $(this).closest('tr').find('td input[name=TaskId]').val();
            //alert(itemDetId);

            RequisitionDelete = JSON.stringify({
                RequisitionDetailId: itemDetId
            });

            $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: '/MaterialRequisition/DeleteRequisitionDetailItem',
                data: RequisitionDelete,
                success: function (result) {
                    console.log(result);
                    if (result.flag === true) {
                        deleteList[deleteCounter] = itemDetId;
                        deleteCounter++;
                        row.remove();
                    }
                    else {
                        alert(result.message);
                    }


                },
                failure: function (response) {
                    alert('error');
                }
            });

    });



    function RebindDatePicker() {
        $('.datepicker').datepicker("destroy");
        $('.datepicker').datepicker({
            format: 'dd/mm/yyyy',
            todayHighlight: true,
            autoclose: true,
            todayBtn: true,
        });

    }
</script>


<style>
    span.error {
        display: block;
        /*visibility: hidden;*/
        color: red;
        font-size: 90%;
    }
</style>